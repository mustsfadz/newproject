<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام إدارة الموظفين — نسخة احترافية متطورة</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --accent: #0b72d4;
      --accent-hover: #095bb4;
      --muted: #6b7280;
      --success: #16a34a;
      --danger: #e11d48;
      --warning: #f59e0b;
      --border: #e8eef6;
      --text: #0e1726;
      --shadow: rgba(14, 30, 60, 0.08);
      --radius: 12px;
      --transition: all 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Cairo', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .wrap {
      max-width: 1200px;
      margin: 28px auto;
      padding: 20px;
    }

    /* تحسينات الشريط العلوي */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), #0a5aa8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 22px;
      box-shadow: 0 4px 12px rgba(11, 114, 212, 0.25);
    }

    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
    }

    .subtitle {
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px;
    }

    /* تحسينات الأزرار */
    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(11, 114, 212, 0.2);
      transition: var(--transition);
      font-size: 14px;
    }

    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(11, 114, 212, 0.25);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.ghost {
      background: #fff;
      color: var(--accent);
      border: 1px solid rgba(11, 114, 212, 0.2);
      box-shadow: none;
    }

    .btn.ghost:hover {
      background: rgba(11, 114, 212, 0.08);
    }

    .btn.success {
      background: var(--success);
      box-shadow: 0 4px 12px rgba(22, 163, 74, 0.2);
    }

    .btn.success:hover {
      background: #15803d;
      box-shadow: 0 6px 16px rgba(22, 163, 74, 0.25);
    }

    .btn.warning {
      background: var(--warning);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }

    .btn.warning:hover {
      background: #d97706;
      box-shadow: 0 6px 16px rgba(245, 158, 11, 0.25);
    }

    /* لوحة البحث والتحكم */
    .panel {
      display: flex;
      gap: 18px;
      margin: 24px 0;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-container {
      flex: 1;
      display: flex;
      gap: 8px;
      align-items: center;
      min-width: 300px;
    }

    .search {
      flex: 1;
      position: relative;
    }

    .search input {
      width: 100%;
      padding: 12px 16px;
      padding-left: 42px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      outline: none;
      font-size: 14px;
      transition: var(--transition);
    }

    .search input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(11, 114, 212, 0.15);
    }

    .search i {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }

    .select {
      padding: 11px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(11, 114, 212, 0.15);
    }

    .small {
      font-size: 14px;
      color: var(--muted);
      max-width: 300px;
    }

    /* بطاقات الإحصائيات */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--card);
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px var(--shadow);
    }

    .stat-card .label {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 800;
      margin: 4px 0;
      color: var(--accent);
    }

    .stat-card .change {
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .stat-card .change.positive {
      color: var(--success);
    }

    .stat-card .change.negative {
      color: var(--danger);
    }

    /* تحسينات الجدول */
    .table-card {
      margin-top: 24px;
      background: var(--card);
      padding: 18px;
      border-radius: var(--radius);
      box-shadow: 0 4px 12px var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .table-title {
      font-size: 18px;
      font-weight: 700;
    }

    .table-actions {
      display: flex;
      gap: 8px;
    }

    .table-responsive {
      overflow: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 680px;
    }

    th, td {
      padding: 14px 16px;
      text-align: right;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    th {
      background: linear-gradient(180deg, #0b72d4, #0a5aa8);
      color: #fff;
      position: sticky;
      top: 0;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    th:hover {
      background: linear-gradient(180deg, #0c7ae8, #0b64c0);
    }

    th i {
      margin-left: 6px;
      font-size: 12px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: #f8fbff;
    }

    /* شريط الحالة */
    .statusbar {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-size: 13px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 999px;
      background: #fff;
      font-size: 13px;
    }

    /* الرسائل والتنبيهات */
    .message {
      margin: 16px 0;
      padding: 14px 18px;
      border-radius: 10px;
      display: none;
      align-items: center;
      gap: 10px;
    }

    .message.error {
      background: #fff0f0;
      color: var(--danger);
      border: 1px solid #ffd6de;
    }

    .message.success {
      background: #f0fdf4;
      color: var(--success);
      border: 1px solid #d1f7d8;
    }

    .message.warning {
      background: #fffbeb;
      color: var(--warning);
      border: 1px solid #fef3c7;
    }

    .message i {
      font-size: 18px;
    }

    /* التذييل */
    .footer {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin-top: 28px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* تحميل وتحميل الشكل */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(11, 114, 212, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* تحسينات للهواتف */
    @media (max-width: 768px) {
      .wrap {
        padding: 16px;
      }
      
      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .actions {
        width: 100%;
        justify-content: center;
        margin-top: 16px;
      }
      
      .panel {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-container {
        min-width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .statusbar {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* تأثيرات للواجهة */
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* عنصر التحميل للجدول */
    .table-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      flex-direction: column;
      gap: 16px;
    }

    .table-loading .loader {
      width: 32px;
      height: 32px;
    }

    .table-loading p {
      color: var(--muted);
      font-size: 15px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><i class="fas fa-users"></i></div>
        <div>
          <h1>نظام إدارة الموظفين المتطور</h1>
          <div class="subtitle">إدارة شاملة لبيانات الموظفين — بحث متقدم وتقارير مفصلة</div>
        </div>
      </div>

      <div class="actions">
        <button id="refreshBtn" class="btn" title="تحديث البيانات">
          <i class="fas fa-rotate"></i> تحديث البيانات
        </button>
        <button id="exportBtn" class="btn ghost" title="تصدير">
          <i class="fas fa-file-export"></i> تصدير
        </button>
        <button id="settingsBtn" class="btn ghost" title="الإعدادات">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">إجمالي الموظفين</div>
        <div class="value" id="totalEmployees">0</div>
        <div class="change positive" id="employeesChange">
          <i class="fas fa-arrow-up"></i> <span>0%</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="label">تم تحميلهم</div>
        <div class="value" id="loadedEmployees">0</div>
        <div class="label">من إجمالي السجلات</div>
      </div>
      <div class="stat-card">
        <div class="label">أحدث تحديث</div>
        <div class="value" id="lastUpdated">—</div>
        <div class="label" id="dataSource">—</div>
      </div>
    </div>

    <div class="panel">
      <div class="search-container">
        <div class="search">
          <input id="searchInput" placeholder="ابحث بالاسم، الرقم الوظيفي، أو المهنة..." />
          <i class="fas fa-search"></i>
        </div>
        <select id="searchType" class="select">
          <option value="all">البحث في الكل</option>
          <option value="name">البحث بالاسم</option>
          <option value="id">البحث بالرقم الوظيفي</option>
          <option value="job">البحث بالمهنة</option>
        </select>
        <button id="clearSearch" class="btn ghost" title="مسح البحث">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="small">
        <i class="fas fa-info-circle"></i> يدعم النظام البحث المتقدم والترتيب حسب الأعمدة
      </div>
    </div>

    <div id="msg" class="message"></div>

    <div class="table-card">
      <div class="table-header">
        <div class="table-title">سجل الموظفين</div>
        <div class="table-actions">
          <button id="sortAsc" class="btn ghost" title="ترتيب تصاعدي">
            <i class="fas fa-arrow-up-wide-short"></i>
          </button>
          <button id="sortDesc" class="btn ghost" title="ترتيب تنازلي">
            <i class="fas fa-arrow-down-wide-short"></i>
          </button>
        </div>
      </div>
      
      <div class="table-responsive">
        <table id="employeesTable">
          <thead>
            <tr>
              <th data-sort="id">الرقم الوظيفي <i class="fas fa-sort"></i></th>
              <th data-sort="name">الاسم الكامل <i class="fas fa-sort"></i></th>
              <th data-sort="job">المسمى الوظيفي <i class="fas fa-sort"></i></th>
              <th data-sort="department">القسم <i class="fas fa-sort"></i></th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="5" style="text-align:center;padding:40px;color:var(--muted)">
                <div class="table-loading">
                  <div class="loader"></div>
                  <p>جاري تحميل بيانات الموظفين...</p>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="statusbar">
        <span class="pill"><i class="fa-regular fa-clock"></i> آخر تحديث: <span id="updateTime">—</span></span>
        <span class="pill"><i class="fa-solid fa-database"></i> مصدر البيانات: <span id="sourceName">—</span></span>
        <a id="openSource" class="pill" target="_blank" rel="noopener">
          <i class="fas fa-external-link-alt"></i> فتح مصدر البيانات
        </a>
        <span class="pill"><i class="fas fa-filter"></i> النتائج المعروضة: <span id="displayCount">0</span> من <span id="totalCount">0</span></span>
      </div>
    </div>

    <div class="footer">
      © 2023 نظام إدارة الموظفين المتطور — إصدار 2.0 | تم التطوير بواسطة فريق التقنية
    </div>
  </div>

  <script>
    // رابط Google Sheets المنشور كـ CSV (عام)
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNUwlWyvA6ayiiNM63jo84YOtMzbk7vIumkSPNGbCg1OWPophMIjEcHHg1797a6uWrtuLdl45cTXkX/pub?output=csv";

    // بدائل تجاوز CORS عند الفشل
    const CORS_PROXIES = [
      (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
      (u) => `https://cors.isomorphic-git.org/${u}`,
      (u) => `https://cors-anywhere.herokuapp.com/${u}`,
    ];

    // عناصر DOM
    const totalEl = document.getElementById('totalEmployees');
    const loadedEl = document.getElementById('loadedEmployees');
    const tableBody = document.getElementById('tableBody');
    const msg = document.getElementById('msg');
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const searchInput = document.getElementById('searchInput');
    const searchType = document.getElementById('searchType');
    const clearSearch = document.getElementById('clearSearch');
    const tableHeaders = document.querySelectorAll('th[data-sort]');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const updateTimeEl = document.getElementById('updateTime');
    const dataSourceEl = document.getElementById('dataSource');
    const sourceNameEl = document.getElementById('sourceName');
    const openSource = document.getElementById('openSource');
    const displayCountEl = document.getElementById('displayCount');
    const totalCountEl = document.getElementById('totalCount');
    const employeesChangeEl = document.getElementById('employeesChange');
    const sortAscBtn = document.getElementById('sortAsc');
    const sortDescBtn = document.getElementById('sortDesc');

    let employeesData = [];
    let lastEmployeeCount = 0;
    let currentSort = { column: 'id', direction: 'asc' };
    let isLoading = false;

    // تهيئة التطبيق
    function initApp() {
      // تحميل البيانات من التخزين المحلي إذا كانت موجودة
      const savedData = localStorage.getItem('employeesData');
      const savedTime = localStorage.getItem('lastUpdated');
      
      if (savedData && savedTime) {
        try {
          employeesData = JSON.parse(savedData);
          renderTable(employeesData);
          updateTotal(employeesData.length);
          setStatus(new Date(parseInt(savedTime)).toLocaleString('ar-EG'), 'التخزين المحلي');
          showMsg('تم تحميل البيانات من الذاكرة المؤقتة', 'success');
        } catch (e) {
          console.error('Error loading cached data:', e);
          localStorage.removeItem('employeesData');
          localStorage.removeItem('lastUpdated');
          fetchSheet();
        }
      } else {
        fetchSheet();
      }
      
      // إضافة event listeners
      setupEventListeners();
    }

    // إعداد مستمعي الأحداث
    function setupEventListeners() {
      searchInput.addEventListener('input', debounce(applySearch, 300));
      searchType.addEventListener('change', applySearch);
      clearSearch.addEventListener('click', clearSearchHandler);
      refreshBtn.addEventListener('click', fetchSheet);
      exportBtn.addEventListener('click', exportData);
      settingsBtn.addEventListener('click', showSettings);
      sortAscBtn.addEventListener('click', () => sortTable(currentSort.column, 'asc'));
      sortDescBtn.addEventListener('click', () => sortTable(currentSort.column, 'desc'));
      
      // إضافة مستمعي الأحداث لرؤوس الجدول للترتيب
      tableHeaders.forEach(th => {
        th.addEventListener('click', () => {
          const column = th.getAttribute('data-sort');
          sortTable(column, currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc');
        });
      });
    }

    // عرض الرسائل
    function showMsg(text, type = 'success') {
      msg.style.display = 'flex';
      msg.className = `message ${type}`;
      
      let icon = 'fa-check-circle';
      if (type === 'error') icon = 'fa-exclamation-circle';
      if (type === 'warning') icon = 'fa-exclamation-triangle';
      
      msg.innerHTML = `<i class="fas ${icon}"></i> <span>${text}</span>`;
      
      clearTimeout(showMsg._t);
      showMsg._t = setTimeout(() => {
        msg.style.display = 'none';
      }, type === 'error' ? 7000 : 4000);
    }

    // الوقت الحالي كسلسلة
    function nowString() {
      const d = new Date();
      return d.toLocaleString('ar-EG');
    }

    // إضافة تأخير للبحث لتحسين الأداء
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // جلب بيانات CSV مع استخدام بدائل CORS
    async function fetchCSVWithFallback(url) {
      // محاولة مباشرة أولاً
      try {
        const res = await fetch(url, { mode: 'cors' });
        if (res.ok) {
          const text = await res.text();
          return { text, source: 'مباشر' };
        }
        throw new Error('HTTP ' + res.status);
      } catch (e) {
        // فشل - نجرب عبر البروكسيات
        for (const build of CORS_PROXIES) {
          const proxyUrl = build(url);
          try {
            const res = await fetch(proxyUrl, { mode: 'cors' });
            if (res.ok) {
              const text = await res.text();
              return { text, source: proxyUrl.split('/')[2] };
            }
          } catch (_) {
            /* تجاهل وحاول التالي */
          }
        }
        throw new Error('تعذّر جلب الملف (CORS/اتصال)');
      }
    }

    // جلب البيانات من الجدول
    async function fetchSheet() {
      if (isLoading) return;
      
      isLoading = true;
      refreshBtn.innerHTML = '<div class="loader"></div> جاري التحميل...';
      refreshBtn.disabled = true;
      
      showMsg('جاري تحميل البيانات من الخادم...', 'success');
      setStatus('—', '—');
      
      try {
        const { text: csv, source } = await fetchCSVWithFallback(SHEET_URL);
        const parsedData = parseCSV(csv);
        
        if (parsedData.length === 0) {
          showMsg('لا توجد بيانات في الجدول أو تعذّر قراءتها', 'error');
          // استخدام بيانات تجريبية كاحتياطي
          employeesData = demoData();
        } else {
          employeesData = parsedData;
        }
        
        // حفظ البيانات محلياً
        localStorage.setItem('employeesData', JSON.stringify(employeesData));
        localStorage.setItem('lastUpdated', Date.now().toString());
        
        renderTable(employeesData);
        updateTotal(employeesData.length);
        setStatus(nowString(), source);
        showMsg(`تم تحميل ${employeesData.length} سجل بنجاح`, 'success');
        
        // تحديث إحصائيات التغيير
        updateChangeStats(employeesData.length);
        
      } catch (err) {
        console.error(err);
        showMsg(err.message || 'خطأ أثناء تحميل الجدول', 'error');
        
        // استخدام بيانات تجريبية كخطة طوارئ
        employeesData = demoData();
        renderTable(employeesData);
        updateTotal(employeesData.length);
        setStatus(nowString(), 'بيانات تجريبية');
      } finally {
        isLoading = false;
        refreshBtn.innerHTML = '<i class="fas fa-rotate"></i> تحديث البيانات';
        refreshBtn.disabled = false;
      }
    }

    // تحديث إحصائيات التغيير
    function updateChangeStats(currentCount) {
      if (lastEmployeeCount > 0) {
        const change = currentCount - lastEmployeeCount;
        const percentChange = ((change / lastEmployeeCount) * 100).toFixed(1);
        
        if (change > 0) {
          employeesChangeEl.className = 'change positive';
          employeesChangeEl.innerHTML = `<i class="fas fa-arrow-up"></i> <span>+${percentChange}%</span>`;
        } else if (change < 0) {
          employeesChangeEl.className = 'change negative';
          employeesChangeEl.innerHTML = `<i class="fas fa-arrow-down"></i> <span>${percentChange}%</span>`;
        } else {
          employeesChangeEl.className = 'change';
          employeesChangeEl.innerHTML = `<i class="fas fa-minus"></i> <span>0%</span>`;
        }
      }
      
      lastEmployeeCount = currentCount;
    }

    // تعيين حالة التحديث
    function setStatus(time, source) {
      lastUpdatedEl.textContent = time;
      updateTimeEl.textContent = time;
      dataSourceEl.textContent = source;
      sourceNameEl.textContent = source;
      openSource.href = SHEET_URL;
    }

    // محلل CSV مع دعم للفواصل داخل علامات الاقتباس
    function parseCSV(csv) {
      const rows = [];
      let row = [];
      let currentCell = '';
      let inQuotes = false;
      
      for (let i = 0; i < csv.length; i++) {
        const char = csv[i];
        const nextChar = csv[i + 1];
        
        if (char === '"') {
          if (inQuotes && nextChar === '"') {
            currentCell += '"';
            i++; // تخطي الاقتباس التالي
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }
        
        if (char === ',' && !inQuotes) {
          row.push(currentCell);
          currentCell = '';
          continue;
        }
        
        if ((char === '\n' || char === '\r') && !inQuotes) {
          // تخطي CRLF
          if (char === '\r' && nextChar === '\n') {
            i++;
          }
          row.push(currentCell);
          rows.push(row);
          row = [];
          currentCell = '';
          continue;
        }
        
        currentCell += char;
      }
      
      // معالجة آخر خلية وصف
      if (currentCell !== '' || row.length > 0) {
        row.push(currentCell);
        rows.push(row);
      }
      
      // تصفية الصفوف الفارغة
      const nonEmptyRows = rows.filter(row => row.some(cell => cell.trim() !== ''));
      
      if (nonEmptyRows.length < 2) return [];
      
      const headers = nonEmptyRows[0];
      const dataRows = nonEmptyRows.slice(1);
      const columnMap = mapColumns(headers);
      
      const result = [];
      for (const row of dataRows) {
        const id = (row[columnMap.id] || '').trim();
        const name = (row[columnMap.name] || '').trim();
        const job = (row[columnMap.job] || '').trim();
        const department = (row[columnMap.department] || '').trim();
        
        if (!id && !name && !job) continue; // تخطي الصفوف الفارغة
        
        result.push({ id, name, job, department });
      }
      
      return result;
    }

    // تعيين تخطيط الأعمدة
    function mapColumns(headers) {
      const map = { id: -1, name: -1, job: -1, department: -1 };
      
      const idKeys = ['الرقم الوظيفي', 'رقم وظيفي', 'id', 'رقم', 'employee_id'];
      const nameKeys = ['الاسم', 'اسم', 'name', 'الاسم الكامل', 'employee_name'];
      const jobKeys = ['المهنة', 'الوظيفة', 'job', 'المسمى الوظيفي', 'position'];
      const departmentKeys = ['القسم', 'قسم', 'department', 'الإدارة', 'section'];
      
      headers.forEach((header, index) => {
        const normalizedHeader = header.replace(/^\ufeff/, '').replace(/^"|"$/g, '').trim().toLowerCase();
        
        if (idKeys.includes(normalizedHeader) && map.id === -1) map.id = index;
        if (nameKeys.includes(normalizedHeader) && map.name === -1) map.name = index;
        if (jobKeys.includes(normalizedHeader) && map.job === -1) map.job = index;
        if (departmentKeys.includes(normalizedHeader) && map.department === -1) map.department = index;
      });
      
      // إذا لم يتم العثور على رؤوس متطابقة، نستخدم أول 4 أعمدة
      if (map.id === -1) map.id = 0;
      if (map.name === -1) map.name = 1;
      if (map.job === -1) map.job = 2;
      if (map.department === -1) map.department = 3;
      
      return map;
    }

    // عرض الجدول
    function renderTable(list) {
      if (!list || list.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align:center;padding:40px;color:var(--muted)">
              <i class="fas fa-inbox" style="font-size:32px;margin-bottom:16px;display:block"></i>
              لا توجد سجلات للعرض
            </td>
          </tr>
        `;
        displayCountEl.textContent = '0';
        totalCountEl.textContent = '0';
        loadedEl.textContent = '0';
        return;
      }
      
      let tableHTML = '';
      list.forEach(employee => {
        tableHTML += `
          <tr class="fade-in">
            <td>${escapeHtml(employee.id)}</td>
            <td>${escapeHtml(employee.name)}</td>
            <td>${escapeHtml(employee.job)}</td>
            <td>${escapeHtml(employee.department || '—')}</td>
            <td>
              <button class="btn ghost" style="padding:6px 10px" onclick="viewEmployee('${escapeHtml(employee.id)}')" title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      tableBody.innerHTML = tableHTML;
      displayCountEl.textContent = list.length;
      totalCountEl.textContent = employeesData.length;
      loadedEl.textContent = list.length;
    }

    // تحديث الإجمالي
    function updateTotal(n) {
      totalEl.textContent = n;
    }

    // هروب HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // تطبيق البحث
    function applySearch() {
      const term = searchInput.value.trim().toLowerCase();
      const type = searchType.value;
      
      if (!term) {
        renderTable(employeesData);
        return;
      }
      
      const filtered = employeesData.filter(employee => {
        if (type === 'all') {
          return (
            (employee.id || '').toLowerCase().includes(term) ||
            (employee.name || '').toLowerCase().includes(term) ||
            (employee.job || '').toLowerCase().includes(term) ||
            (employee.department || '').toLowerCase().includes(term)
          );
        }
        
        if (type === 'name') return (employee.name || '').toLowerCase().includes(term);
        if (type === 'id') return (employee.id || '').toLowerCase().includes(term);
        if (type === 'job') return (employee.job || '').toLowerCase().includes(term);
        
        return true;
      });
      
      renderTable(filtered);
    }

    // مسح البحث
    function clearSearchHandler() {
      searchInput.value = '';
      applySearch();
    }

    // ترتيب الجدول
    function sortTable(column, direction) {
      currentSort = { column, direction };
      
      // تحديث أيقونات الترتيب في الرؤوس
      tableHeaders.forEach(th => {
        const thColumn = th.getAttribute('data-sort');
        const icon = th.querySelector('i');
        
        if (thColumn === column) {
          icon.className = direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
        } else {
          icon.className = 'fas fa-sort';
        }
      });
      
      employeesData.sort((a, b) => {
        let valueA = (a[column] || '').toString().toLowerCase();
        let valueB = (b[column] || '').toString().toLowerCase();
        
        // محاولة التحويل إلى أرقام للمقارنة إذا كان ذلك ممكنا
        const numA = Number(valueA);
        const numB = Number(valueB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
          return direction === 'asc' ? numA - numB : numB - numA;
        }
        
        // مقارنة نصية
        if (valueA < valueB) return direction === 'asc' ? -1 : 1;
        if (valueA > valueB) return direction === 'asc' ? 1 : -1;
        return 0;
      });
      
      applySearch();
    }

    // تصدير البيانات
    function exportData() {
      if (!employeesData || employeesData.length === 0) {
        showMsg('لا توجد بيانات للتصدير', 'error');
        return;
      }
      
      let csv = '\ufeff'; // BOM for UTF-8
      csv += 'الرقم الوظيفي,الاسم,المهنة,القسم\n';
      
      employeesData.forEach(employee => {
        csv += `"${(employee.id || '').replace(/"/g, '""')}",`;
        csv += `"${(employee.name || '').replace(/"/g, '""')}",`;
        csv += `"${(employee.job || '').replace(/"/g, '""')}",`;
        csv += `"${(employee.department || '').replace(/"/g, '""')}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const date = new Date().toISOString().slice(0, 10);
      
      a.href = url;
      a.download = `موظفين_${date}.csv`;
      a.style.display = 'none';
      
      document.body.appendChild(a);
      a.click();
      
      // التنظيف
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      showMsg('تم تصدير البيانات بنجاح', 'success');
    }

    // عرض الإعدادات
    function showSettings() {
      showMsg('سيتم إضافة نافذة الإعدادات في نسخة لاحقة', 'warning');
    }

    // عرض تفاصيل الموظف
    function viewEmployee(id) {
      const employee = employeesData.find(emp => emp.id === id);
      if (employee) {
        showMsg(`عرض تفاصيل الموظف: ${employee.name} (${employee.id})`, 'success');
        // هنا يمكن فتح نافذة أو模态 لعرض التفاصيل الكاملة
      }
    }

    // بيانات تجريبية
    function demoData() {
      return [
        { id: 'D-1001', name: 'أحمد محمد عبدالله', job: 'محاسب', department: 'المالية' },
        { id: 'D-1002', name: 'سارة خالد أحمد', job: 'مطور واجهات', department: 'التقنية' },
        { id: 'D-1003', name: 'علي حسن إبراهيم', job: 'أخصائي موارد بشرية', department: 'الموارد البشرية' },
        { id: 'D-1004', name: 'فاطمة عبد الرحمن', job: 'مديرة تسويق', department: 'التسويق' },
        { id: 'D-1005', name: 'محمد نور سليمان', job: 'مهندس برمجيات', department: 'التطوير' },
        { id: 'D-1006', name: 'ريم عبد العزيز', job: 'مسؤولة علاقات عملاء', department: 'خدمة العملاء' },
        { id: 'D-1007', name: 'خالد أمين فارس', job: 'مدير مشاريع', department: 'إدارة المشاريع' },
      ];
    }

    // بدء التطبيق عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
